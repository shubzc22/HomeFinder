<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Auto-join Jitsi — Auto</title>

  <style>
    html,body,#jitsi-container{height:100%;margin:0;background:#f4f5f8;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    #jitsi-container iframe{height:100%;width:100%;border:0}
    .share-popup{
      position:fixed;left:50%;transform:translateX(-50%);top:12px;z-index:10000;
      background:#fff;padding:10px 12px;border-radius:8px;
      box-shadow:0 6px 18px rgba(0,0,0,.12);display:flex;gap:8px;align-items:center
    }
    .link{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:520px;font-size:13px}
    .btn-copy{padding:6px 10px;background:#0b74ff;color:#fff;border:0;border-radius:6px;cursor:pointer}
    .copied-hint{font-size:12px;color:green;margin-left:6px}
  </style>

  <script src="https://meeting.experte.de/external_api.js"></script>
</head>
<body>

<div id="jitsi-container"></div>

<div id="sharePopup" class="share-popup" style="display:none">
  <div class="link" id="shareLink">—</div>
  <button id="copyBtn" class="btn-copy">Copy link</button>
  <div id="copiedHint" class="copied-hint" style="display:none">Copied!</div>
</div>

<script>
/* ==============================
      UNIQUE ROOM SYSTEM
============================== */

function r(l=6){const c='abcdefghijklmnopqrstuvwxyz0123456789';let s='';for(let i=0;i<l;i++)s+=c[Math.floor(Math.random()*c.length)];return s;}
function makeRoom(){return `room-${Date.now()}-${r(5)}`;}

function getRoom(){
  const p = new URLSearchParams(location.search);
  return p.get("room");
}

function setRoom(room){
  const u = new URL(location.href);
  u.searchParams.set("room", room);
  history.replaceState({}, "", u.toString());
}

let room = getRoom();
let creator = false;

if(!room){
  room = makeRoom();
  setRoom(room);
  creator = true; // first opener = moderator
}

/* ==============================
      JITSI INIT
============================== */

const domain = "meeting.experte.de";

const api = new JitsiMeetExternalAPI(domain, {
  roomName: room,
  parentNode: document.getElementById("jitsi-container"),
  configOverwrite: {
    prejoinPageEnabled: false,
    startWithAudioMuted: true,
    startWithVideoMuted: true
  },
  userInfo: { displayName: creator ? "Moderator" : "Participant" }
});

/* ==============================
    FORCE MIC / CAMERA STATES
============================== */

async function micOn(){
  try { api.executeCommand("setAudioMuted", false); }
  catch { api.executeCommand("toggleAudio"); }
}

async function camOn(){
  try { api.executeCommand("setVideoMuted", false); }
  catch { api.executeCommand("toggleVideo"); }
}

async function camOff(){
  try { api.executeCommand("setVideoMuted", true); }
  catch { api.executeCommand("toggleVideo"); }
}

/* ==============================
      BACK CAMERA SWITCH
============================== */

async function enableBackCam(retries=6){
  for(let i=0;i<retries;i++){
    try{
      const d = await api.getAvailableDevices();
      const cams = d.videoInput || [];

      const back = cams.find(v =>
        v.label.toLowerCase().includes("back") ||
        v.label.toLowerCase().includes("rear") ||
        v.label.toLowerCase().includes("environment")
      );

      if(back){
        await api.setVideoInputDevice(back.deviceId);
        await camOn();
        return;
      }
    }catch(e){}
    await new Promise(r=>setTimeout(r,400));
  }
}

/* ==============================
       MODERATOR / GUEST LOGIC
============================== */

api.addEventListener("videoConferenceJoined", async () => {

  await new Promise(r=>setTimeout(r,200));

  const others = await api.getNumberOfParticipants();
  const moderator = creator || others === 0;

  if(moderator){
    // MODERATOR: mic ON + back camera ON
    await micOn();
    await camOn();
    enableBackCam();
  }
  else{
    // PARTICIPANT: mic ON + camera OFF
    await micOn();
    await camOff();
  }

  // Show share link
  setTimeout(()=>{
    const url = location.href;
    document.getElementById("shareLink").textContent = url;

    const btn = document.getElementById("copyBtn");
    btn.onclick = async ()=>{
      try{
        await navigator.clipboard.writeText(url);
        document.getElementById("copiedHint").style.display="block";
        setTimeout(()=>document.getElementById("copiedHint").style.display="none",1200);
      }catch(e){ alert("Copy failed"); }
    };

    document.getElementById("sharePopup").style.display="flex";
  },600);

});
</script>
</body>
</html>
