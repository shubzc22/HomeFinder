<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Auto-join Jitsi — Moderator back-cam ON</title>
  <style>
    html,body,#jitsi-container{height:100%;margin:0;background:#f4f5f8}
    #jitsi-container iframe{height:100%;width:100%;border:0}
    .notice{position:fixed;left:12px;top:12px;z-index:9999;background:#fff;padding:8px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
  </style>

  <!-- load external_api from your Jitsi domain -->
  <script src="https://meeting.experte.de/external_api.js"></script>
</head>
<body>
  <div class="notice" id="notice">Joining meeting automatically...</div>
  <div id="jitsi-container"></div>

<script>
/*
  Behaviour:
  - First user (isModerator=true): mic ON, back camera ON
  - Later users (isModerator=false): mic ON, camera OFF

  Notes:
  - Browsers may block automatic camera/mic without user permission.
  - On mobile labels may be hidden until you request getUserMedia once; we do that.
*/

const ROOM_NAME = "t8oNswv5Tj";
const domain = "meeting.experte.de";

// === logic to decide moderator or guest ===
// Currently "first user = moderator" hardcoded. Replace with your logic if needed.
let isModerator = true; // change to false for testing guest behaviour

const options = {
  roomName: ROOM_NAME,
  parentNode: document.getElementById("jitsi-container"),
  configOverwrite: {
    prejoinPageEnabled: false,
    // Keep video muted initially so we can set correct device before enabling it
    startWithAudioMuted: false,
    startWithVideoMuted: true
  },
  interfaceConfigOverwrite: {
    DEFAULT_BACKGROUND: '#f4f5f8',
    SHOW_JITSI_WATERMARK: false,
    SHOW_WATERMARK_FOR_GUESTS: false,
    APP_NAME: 'EXPERTE.com Online Meeting'
  },
  userInfo: {
    displayName: isModerator ? "Moderator" : "Guest"
  }
};

let api;
try {
  api = new JitsiMeetExternalAPI(domain, options);
} catch (err) {
  console.error("Jitsi API init error:", err);
  document.getElementById('notice').textContent = 'Could not start meeting automatically — check console.';
}

// small helper
const sleep = ms => new Promise(res => setTimeout(res, ms));

async function tryEnableModeratorBackCamera() {
  if (!api) return;

  // 1) Try to get permission once so device labels are exposed (important on mobile)
  try {
    // Request minimal permission (video only) — this may prompt user
    await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
  } catch (e) {
    // permission denied or blocked — still proceed to enumerate if possible
    console.warn("getUserMedia permission error (may still work):", e);
  }

  // 2) Get available devices via Jitsi API
  let devices;
  try {
    devices = await api.getAvailableDevices();
  } catch (e) {
    console.warn("api.getAvailableDevices error:", e);
    devices = null;
  }

  const videoInputs = (devices && devices.videoInput) ? devices.videoInput : [];

  // 3) Find back/rear/environment camera by common label keywords
  let backCam = videoInputs.find(d => /back|rear|environment|wide-angle/i.test(d.label));

  // If not found by label, try a fallback: choose device whose label contains 'camera' but try last devices (often rear is last)
  if (!backCam && videoInputs.length > 0) {
    backCam = videoInputs[videoInputs.length - 1];
  }

  if (backCam) {
    try {
      await api.setVideoInputDevice(backCam.deviceId);
      console.log("Selected video device:", backCam.label || backCam.deviceId);

      // small delay to allow device switch to take effect
      await sleep(300);

      // 4) Now enable video (we started with video muted)
      // toggleVideo will unmute (start) the video
      api.executeCommand('toggleVideo');
      document.getElementById('notice').textContent = 'Moderator: back camera ON';
      console.log("Moderator video started using back camera.");
    } catch (e) {
      console.warn("Error setting video input or starting video:", e);
      document.getElementById('notice').textContent = 'Could not enable moderator camera automatically.';
    }
  } else {
    console.warn("No video input devices found.");
    document.getElementById('notice').textContent = 'No camera found.';
  }
}

api && api.addEventListener('videoConferenceJoined', async () => {
  console.log('Joined conference — isModerator=', isModerator);

  // Try to ensure mic ON — note: browser policies may prevent auto-unmute in some cases.
  try {
    // Some deployments start muted; attempt to unmute
    api.executeCommand('toggleAudio'); // toggle once
    await sleep(120);
    // If still muted, try again (idempotent attempt)
    api.executeCommand('toggleAudio');
  } catch (e) {
    console.warn("toggleAudio failed:", e);
  }

  if (isModerator) {
    // For moderator, attempt to set back camera and then turn video ON
    await tryEnableModeratorBackCamera();
  } else {
    // For guests: ensure camera is OFF (we started muted), and leave mic ON
    document.getElementById('notice').textContent = 'Guest: mic ON, camera OFF';
    console.log("Guest joined → mic ON (attempted), camera left OFF");
  }
});
</script>
</body>
</html>
